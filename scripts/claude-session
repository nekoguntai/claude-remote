#!/usr/bin/env bash
#
# claude-session - Create or attach to a persistent tmux session
#
# Usage: claude-session [session-name]
#        claude-session --list
#        claude-session --kill <session-name>
#

set -e

# Ensure Homebrew is in PATH on macOS (for non-interactive shells)
if [[ "$OSTYPE" == "darwin"* ]]; then
    if ! command -v tmux &>/dev/null; then
        if [[ -f "/opt/homebrew/bin/brew" ]]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
        elif [[ -f "/usr/local/bin/brew" ]]; then
            eval "$(/usr/local/bin/brew shellenv)"
        fi
    fi
fi

TMUX_CONF="${HOME}/.tmux.conf"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[OK]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

show_help() {
    cat << EOF
claude-session - Persistent tmux session manager

Usage:
    claude-session [session-name]    Create or attach to session (default: main)
    claude-session --list            List all active sessions
    claude-session --kill <name>     Kill a specific session
    claude-session --kill-all        Kill all sessions
    claude-session --help            Show this help

Session names:
    Must contain only alphanumeric characters, underscores, and hyphens.
    Examples: main, claude, my-project, work_2024

Examples:
    claude-session                   Attach to 'main' session
    claude-session claude            Attach to 'claude' session
    claude-session --list            Show all sessions

Session Persistence:
    Sessions persist even when you disconnect. Start a long-running
    process, disconnect, and it will continue running. Reconnect
    anytime to see the output.

EOF
}

validate_session_name() {
    local name="$1"
    # Allow only alphanumeric, underscore, and hyphen (1-64 chars)
    if [[ ! "$name" =~ ^[a-zA-Z0-9_-]{1,64}$ ]]; then
        print_error "Invalid session name: '$name'"
        print_error "Use only alphanumeric characters, underscores, and hyphens (max 64 chars)"
        exit 1
    fi
}

list_sessions() {
    if tmux list-sessions 2>/dev/null; then
        echo ""
        print_info "To attach: claude-session <session-name>"
    else
        print_warning "No active tmux sessions"
    fi
}

kill_session() {
    local target="$1"
    validate_session_name "$target"
    if tmux kill-session -t "$target" 2>/dev/null; then
        print_success "Killed session: $target"
    else
        print_error "Session not found: $target"
        exit 1
    fi
}

kill_all_sessions() {
    if tmux kill-server 2>/dev/null; then
        print_success "All sessions terminated"
    else
        print_warning "No sessions to kill"
    fi
}

# Parse arguments
case "$1" in
    --help|-h)
        show_help
        exit 0
        ;;
    --list|-l)
        list_sessions
        exit 0
        ;;
    --kill|-k)
        if [ -z "$2" ]; then
            print_error "Please specify a session name to kill"
            exit 1
        fi
        kill_session "$2"
        exit 0
        ;;
    --kill-all)
        kill_all_sessions
        exit 0
        ;;
esac

# Set and validate session name
SESSION_NAME="${1:-main}"
validate_session_name "$SESSION_NAME"

# Check if tmux is installed
if ! command -v tmux &> /dev/null; then
    print_error "tmux is not installed. Please run the installer first."
    exit 1
fi

# Check if session exists
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    print_info "Attaching to existing session: $SESSION_NAME"

    # If inside tmux, switch to session; otherwise attach
    if [ -n "$TMUX" ]; then
        tmux switch-client -t "$SESSION_NAME"
    else
        tmux attach-session -t "$SESSION_NAME"
    fi
else
    print_info "Creating new session: $SESSION_NAME"

    # Create new session
    # If inside tmux, create detached and switch; otherwise create attached
    if [ -n "$TMUX" ]; then
        tmux new-session -d -s "$SESSION_NAME"
        tmux switch-client -t "$SESSION_NAME"
    else
        tmux new-session -s "$SESSION_NAME"
    fi
fi
