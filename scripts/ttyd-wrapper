#!/usr/bin/env bash
#
# ttyd-wrapper - Wrapper script to launch ttyd with credentials
#
# This script reads credentials from the config file and launches ttyd
# with proper authentication and security settings.
#
# SECURITY NOTE: The password is passed via --credential flag which is visible
# in the process list (ps aux). On multi-user systems, this is a known limitation
# of ttyd's design. Mitigations:
# - This script has 700 permissions (owner-only)
# - Primary authentication should be via Tailscale (Tailnet-only access)
# - The password provides defense-in-depth, not primary security
# - For multi-user systems, consider using a reverse proxy with auth instead
#

set -e

# Ensure Homebrew is in PATH on macOS (launchd doesn't inherit shell PATH)
if [[ "$OSTYPE" == "darwin"* ]]; then
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f "/usr/local/bin/brew" ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
fi

CONFIG_DIR="${HOME}/.config/claude-remote"
CRED_FILE="${CONFIG_DIR}/web-credentials"
SESSION_NAME="${CLAUDE_SESSION:-main}"

# Warn on multi-user systems
check_multi_user() {
    local user_count
    user_count=$(who | awk '{print $1}' | sort -u | wc -l)
    if [[ "$user_count" -gt 1 ]]; then
        echo "WARNING: Multiple users detected on this system." >&2
        echo "The web terminal password may be visible in the process list." >&2
        echo "Rely on Tailscale authentication as your primary security layer." >&2
    fi
}

check_multi_user

# Check for credential file
if [[ ! -f "$CRED_FILE" ]]; then
    echo "ERROR: Credential file not found: $CRED_FILE" >&2
    echo "Please run the installer first." >&2
    exit 1
fi

# Read password (use subshell to avoid leaving in environment)
WEB_PASSWORD="$(cat "$CRED_FILE")"

if [[ -z "$WEB_PASSWORD" ]]; then
    echo "ERROR: Empty credential file" >&2
    exit 1
fi

# Find ttyd
TTYD_PATH=""
for path in "${HOME}/.local/bin/ttyd" "/usr/local/bin/ttyd" "/opt/homebrew/bin/ttyd" "/usr/bin/ttyd"; do
    if [[ -x "$path" ]]; then
        TTYD_PATH="$path"
        break
    fi
done

if [[ -z "$TTYD_PATH" ]]; then
    echo "ERROR: ttyd not found" >&2
    exit 1
fi

# Find web-terminal script
WEB_TERMINAL="${HOME}/.local/bin/web-terminal"
if [[ ! -x "$WEB_TERMINAL" ]]; then
    echo "ERROR: web-terminal script not found: $WEB_TERMINAL" >&2
    exit 1
fi

# Launch ttyd with security settings
exec "$TTYD_PATH" \
    --writable \
    --port 7681 \
    --interface 127.0.0.1 \
    --max-clients 2 \
    --credential "claude:${WEB_PASSWORD}" \
    "$WEB_TERMINAL"
