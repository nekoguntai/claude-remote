#!/usr/bin/env bash
#
# web-terminal - Wrapper script for ttyd to attach to tmux
#
# This script is executed by ttyd for each web connection.
# It attaches to an existing tmux session or creates a new one.
#

set -e

# Ensure Homebrew is in PATH on macOS (ttyd doesn't inherit shell PATH)
if [[ "$OSTYPE" == "darwin"* ]]; then
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f "/usr/local/bin/brew" ]]; then
        eval "$(/usr/local/bin/brew shellenv)"
    fi
fi

# Ensure ~/.local/bin is in PATH
if [[ -d "${HOME}/.local/bin" ]]; then
    export PATH="${HOME}/.local/bin:${PATH}"
fi

SESSION_NAME="${ANYSHELL_SESSION:-main}"

# Validate session name to prevent injection attacks
if [[ ! "$SESSION_NAME" =~ ^[a-zA-Z0-9_-]{1,64}$ ]]; then
    echo "ERROR: Invalid session name: '$SESSION_NAME'" >&2
    echo "Session names must be 1-64 characters, alphanumeric with _ and - allowed." >&2
    exit 1
fi

# Ensure tmux session exists
if ! tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
    # Create session detached first
    tmux new-session -d -s "$SESSION_NAME"
fi

# Attach to the session
# Using -d to detach other clients prevents multiple web tabs from conflicting
# Remove -d if you want to allow multiple viewers of the same session
exec tmux attach-session -t "$SESSION_NAME"
